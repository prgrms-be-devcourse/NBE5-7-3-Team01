<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>공연 수정</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          margin: 40px;
      }

      form {
          display: flex;
          flex-direction: column;
          gap: 12px;
          max-width: 400px;
      }

      label {
          font-weight: bold;
      }

      input, select, textarea, button {
          padding: 8px;
          font-size: 14px;
      }

      .image-preview {
          max-width: 200px;
          height: auto;
          margin-bottom: 10px;
          border: 1px solid #ccc;
      }
  </style>
</head>
<body>
<h1>공연 수정</h1>
<form id="performance-form" action="#" enctype="multipart/form-data">
  <div th:if="${performance.encodedFileName}">
    <label>현재 포스터 이미지</label>
    <img th:src="@{{url}(url=${performance.url})}" alt="현재 포스터" class="image-preview"/>
  </div>

  <label for="title">제목</label>
  <input type="text" id="title" name="title" th:value="${performance.title}" required>

  <label for="description">설명</label>
  <textarea id="description" name="description" required th:text="${performance.description}"></textarea>

  <label for="startTime">시작 시간</label>
  <input type="datetime-local" id="startTime" name="startTime" th:value="${#temporals.format(performance.startTime, 'yyyy-MM-dd''T''HH:mm')}" required>
  <label for="endTime">종료 시간</label>
  <input type="datetime-local" id="endTime" name="endTime" th:value="${#temporals.format(performance.endTime, 'yyyy-MM-dd''T''HH:mm')}" required>

  <label for="reservationStartTime">예매 시작 시간</label>
  <input type="datetime-local" id="reservationStartTime" name="reservationStartTime" th:value="${#temporals.format(performance.reservationStartTime, 'yyyy-MM-dd''T''HH:mm')}" required>

  <label for="category">카테고리</label>
  <select id="category" name="category" required>
    <option value="CONCERT" th:selected="${performance.category == 'CONCERT'}">콘서트</option>
    <option value="MOVIE" th:selected="${performance.category == 'MOVIE'}">영화</option>
    <option value="SPORTS" th:selected="${performance.category == 'SPORTS'}">스포츠</option>
  </select>

  <label for="performanceStatus">예매 가능 여부</label>
  <select id="performanceStatus" name="performanceStatus">
    <option value="true" th:selected="${performance.performanceStatus}">예매 가능</option>
    <option value="false" th:selected="${!performance.performanceStatus}">예매 불가</option>
  </select>

  <label for="placeId">장소 ID</label>
  <select id="placeId" name="placeId" required>
    <option value="" disabled selected>장소를 선택해주세요.</option>
    <th:block th:each="place : ${places}">
      <option th:value="${place.id}" th:text="${place.name}" th:selected="${performance.place == place.name}"></option>
    </th:block>
  </select>

  <label for="file">포스터 이미지 변경</label>
  <input type="file" id="file" name="file" accept="image/*">

  <button type="submit">수정</button>
</form>

<script>
    document.getElementById("performance-form").addEventListener("submit", async function (e) {
        e.preventDefault();

        const form = e.target;
        const pathSegments = window.location.pathname.split('/');
        const perfId = pathSegments[pathSegments.length - 1];

        const dto = {
            title: form.title.value,
            description: form.description.value,
            startTime: form.startTime.value,
            endTime: form.endTime.value,
            reservationStartTime: form.reservationStartTime.value,
            category: form.category.value,
            performanceStatus: form.performanceStatus.value === "true",
            placeId: Number(form.placeId.value),
        };

        const file = form.file.files[0];
        const formData = new FormData();
        formData.append("file", file);
        formData.append("request", new Blob([JSON.stringify(dto)], { type: "application/json" }));

        try {
            const res = await fetch(`/api/performances/${perfId}`, { // 변경된 변수명 사용
                method: "PUT",
                body: formData
            });

            const text = await res.text();
            if (res.ok) {
                alert("공연 정보 수정 성공: " + text);
                window.location.href = '/admin/performances';
            } else {
                alert("수정 실패: " + text);
            }
        } catch (err) {
            console.error("에러:", err);
            alert("서버와 통신 중 오류가 발생했습니다.");
        }
    });

    document.getElementById("placeId").addEventListener("change", async function () {
        const placeId = this.value;
        const gradeContainer = document.getElementById("grade-container");
        gradeContainer.innerHTML = "";

        try {
            const response = await fetch(`/api/grades/places/${placeId}`);
            if (!response.ok) throw new Error("Grade 정보의 로드가 실패했습니다.");
            const grades = await response.json();

            if (grades.length === 0) {
                gradeContainer.innerText = "<p>해당 장소에 등록된 좌석 등급이 없습니다.</p>"
                return;
            }

            const table = document.createElement("table");
            table.innerHTML =
                `
                <thead>
                  <tr>
                    <th>등급</th>
                    <th>좌석 수</th>
                    <th>기본 가격</th>
                  </tr>
                </thead>
                <tbody>
                  ${grades.map(grade => `
                    <tr>
                      <td>${grade.grade}</td>
                      <td>${grade.seatCount}</td>
                      <td>${grade.defaultPrice.toLocaleString()}원</td>
                    </tr>
                  `).join('')}
                </tbody>
                `;
            gradeContainer.appendChild(table);
        } catch (err) {
            console.log(err);
            gradeContainer.innerHTML = "<p style='color:red;'>등급 정보를 불러오는 중 오류가 발생했습니다.</p>";
        }
    });
</script>
</body>
</html>